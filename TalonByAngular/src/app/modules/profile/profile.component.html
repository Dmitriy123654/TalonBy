<div class="profile-page" *ngIf="currentUser">
  <div class="container">
    <div class="profile-header">
      <h1 class="user-email">{{ currentUser.email }}</h1>
      <div class="header-links">
        <a href="javascript:void(0)" class="settings-link" (click)="setActiveTab('settings')">Настройки аккаунта</a>
        <a *ngIf="hasAdminAccess" routerLink="/admin" class="settings-link admin-settings-link">Настройки(работа)</a>
        <a href="javascript:void(0)" class="logout-link" (click)="logout()">Выйти</a>
      </div>
    </div>

    <div class="profile-tabs">
      <ul class="tabs">
        <li class="tab" [class.active]="activeTab === 'patients'" (click)="setActiveTab('patients')">
          Пациенты
        </li>
        <li class="tab" [class.active]="activeTab === 'appointments'" (click)="setActiveTab('appointments')">
          Талоны
        </li>
        <li class="tab" [class.active]="activeTab === 'visits'" (click)="setActiveTab('visits')">
          Вызовы врача
        </li>
        <li class="tab" [class.active]="activeTab === 'analyses'" (click)="setActiveTab('analyses')">
          Анализы
        </li>
        <li class="tab" [class.active]="activeTab === 'settings'" (click)="setActiveTab('settings')">
          Настройки аккаунта
        </li>
      </ul>
    </div>

    <div class="profile-content">
      <!-- Пациенты tab content -->
      <div class="patients-section" *ngIf="activeTab === 'patients'">
        <div *ngIf="currentUser.patients && currentUser.patients.length > 0; else noPatients" class="patients-grid">
          <!-- List of added patients -->
          <div class="patient-card" *ngFor="let patient of currentUser.patients">
            <div class="card-header">
              <h2>{{ patient.fullName }}</h2>
            </div>
            <div class="card-body">
              <div class="profile-gender">{{ patient.relationship === 'male' ? 'Мужской' : patient.relationship === 'female' ? 'Женский' : 'Пол не указан' }}</div>
              <div class="profile-birthdate">{{ patient.birthDate | date:'dd.MM.yyyy' }}</div>
              <div class="profile-address" *ngIf="patient.address">{{ patient.address }}</div>
            </div>
            <div class="card-actions">
              <button (click)="editPatient(patient.patientId)" class="btn btn-primary btn-sm">
                <i class="fas fa-edit"></i>
              </button>
              <button (click)="deletePatient(patient.patientId)" class="btn btn-danger btn-sm">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>

          <!-- Add patient cards (up to 6 - current patients) -->
          <ng-container *ngIf="(currentUser?.patients?.length || 0) < 6">
            <div class="patient-card add-patient" *ngFor="let i of getRemainingPatientsSlots()" (click)="addAdultPatient()">
              <div class="add-patient-content">
                <span class="add-patient-text">Добавить пациента</span>
              </div>
            </div>
          </ng-container>
        </div>
        
        <ng-template #noPatients>
          <div class="empty-state">
            <p>У вас пока нет добавленных пациентов</p>
            <button type="button" class="btn btn-primary" (click)="addAdultPatient()">Добавить пациента</button>
          </div>
        </ng-template>
      </div>

      <!-- Appointments tab content -->
      <div class="appointments-section" *ngIf="activeTab === 'appointments'">
        <h2>Ваши талоны</h2>
        
        <!-- Filter controls -->
        <div class="filter-controls">
          <div class="status-filters">
            <button 
              class="status-filter-btn" 
              [class.active]="appointmentFilterStatus === AppointmentStatus.All"
              (click)="filterByStatus(AppointmentStatus.All)">
              Все
            </button>
            <button 
              class="status-filter-btn" 
              [class.active]="appointmentFilterStatus === AppointmentStatus.Waiting"
              (click)="filterByStatus(AppointmentStatus.Waiting)">
              Ожидаются
            </button>
            <button 
              class="status-filter-btn" 
              [class.active]="appointmentFilterStatus === AppointmentStatus.Completed"
              (click)="filterByStatus(AppointmentStatus.Completed)">
              Выполненные
            </button>
            <button 
              class="status-filter-btn" 
              [class.active]="appointmentFilterStatus === AppointmentStatus.Cancelled"
              (click)="filterByStatus(AppointmentStatus.Cancelled)">
              Отменённые
            </button>
          </div>
          
          <div class="date-filters">
            <div class="date-filter-group">
              <label for="dateFrom">С:</label>
              <input 
                type="date" 
                id="dateFrom" 
                [(ngModel)]="dateFrom" 
                class="form-control date-input">
            </div>
            
            <div class="date-filter-group">
              <label for="dateTo">По:</label>
              <input 
                type="date" 
                id="dateTo" 
                [(ngModel)]="dateTo" 
                class="form-control date-input">
            </div>
            
            <button class="btn btn-primary btn-sm" (click)="applyDateFilter()">
              Применить
            </button>
            
            <button class="btn btn-outline-secondary btn-sm" (click)="resetDateFilter()">
              Сбросить
            </button>
          </div>
        </div>
        
        <!-- Loading indicator -->
        <div class="loading-indicator" *ngIf="isLoadingAppointments">
          <div class="spinner"></div>
          <p>Загрузка талонов...</p>
        </div>
        
        <!-- Appointments list -->
        <div class="appointments-list" *ngIf="!isLoadingAppointments">
          <div class="no-appointments" *ngIf="appointments.length === 0">
            <p>У вас пока нет талонов. Вы можете <a routerLink="/order">записаться на прием</a>.</p>
          </div>
          
          <div class="appointment-card" *ngFor="let appointment of appointments">
            <div class="appointment-status" [ngClass]="getStatusClass(appointment.receptionStatus)">
              <span>{{ getStatusTranslation(appointment.receptionStatus) }}</span>
            </div>
            
            <div class="appointment-datetime">
              <div class="appointment-date">{{ formatAppointmentDate(appointment.date) }}</div>
              <div class="appointment-time">{{ appointment.time }}</div>
            </div>
            
            <div class="appointment-hospital">
              <h4>{{ appointment.hospitalName }}</h4>
            </div>
            
            <div class="appointment-doctor">
              <div class="doctor-specialty">{{ appointment.doctorSpecialty }}</div>
              <div class="doctor-name">{{ appointment.doctorName }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Visits tab content -->
      <div class="visits-section" *ngIf="activeTab === 'visits'">
        <h2>Вызовы врача</h2>
        <p *ngIf="true" class="empty-state">У вас пока нет вызовов врача.</p>
      </div>

      <!-- Analyses tab content -->
      <div class="analyses-section" *ngIf="activeTab === 'analyses'">
        <h2>Анализы</h2>
        <p *ngIf="true" class="empty-state">У вас пока нет анализов.</p>
      </div>

      <!-- Settings tab content -->
      <div class="settings-section" *ngIf="activeTab === 'settings'">
        <h2>Настройки аккаунта</h2>
        <div class="settings-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" [(ngModel)]="userSettings.email" class="form-control" required 
                   pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" 
                   [class.is-invalid]="emailInvalid && isUserFormSubmitted">
            <div class="error-feedback" *ngIf="emailInvalid && isUserFormSubmitted">
              Введите корректный email
            </div>
          </div>
          <div class="form-group">
            <label for="phone">Телефон</label>
            <input type="tel" id="phone" [(ngModel)]="userSettings.phone" class="form-control" required 
                   [mask]="'(00)000-00-00'"
                   prefix="+375"
                   [showMaskTyped]="true"
                   [dropSpecialCharacters]="false"
                   [clearIfNotMatch]="false"
                   [class.is-invalid]="phoneInvalid && isUserFormSubmitted">
            <div class="error-feedback" *ngIf="phoneInvalid && isUserFormSubmitted">
              Формат: +375 (XX) XXX-XX-XX
            </div>
          </div>
          
          <div class="password-section">
            <h3>Изменение пароля</h3>
            <div class="form-group">
              <label for="currentPassword">Текущий пароль</label>
              <input type="password" id="currentPassword" [(ngModel)]="passwordChange.currentPassword" class="form-control"
                     [class.is-invalid]="currentPasswordInvalid && isPasswordFormSubmitted">
              <div class="error-feedback" *ngIf="currentPasswordInvalid && isPasswordFormSubmitted">
                Введите текущий пароль
              </div>
            </div>
            <div class="form-group">
              <label for="newPassword">Новый пароль</label>
              <input type="password" id="newPassword" [(ngModel)]="passwordChange.newPassword" class="form-control"
                     pattern="^(?=.*[A-Z])(?=.*[0-9]).*$" 
                     [class.is-invalid]="newPasswordInvalid && isPasswordFormSubmitted">
              <div class="error-feedback" *ngIf="newPasswordInvalid && isPasswordFormSubmitted">
                Пароль должен содержать минимум 6 символов, хотя бы одну заглавную букву и цифру
              </div>
            </div>
            <div class="form-group">
              <label for="confirmPassword">Подтверждение пароля</label>
              <input type="password" id="confirmPassword" [(ngModel)]="passwordChange.confirmPassword" class="form-control"
                     [class.is-invalid]="confirmPasswordInvalid && isPasswordFormSubmitted">
              <div class="error-feedback" *ngIf="confirmPasswordInvalid && isPasswordFormSubmitted">
                Пароли не совпадают
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-primary" (click)="changePassword()">Изменить пароль</button>
            </div>
          </div>
          
          <div class="form-actions user-settings-actions">
            <button type="button" class="btn btn-primary" (click)="saveUserSettings()">Сохранить настройки</button>
          </div>
        </div>
      </div>

      <!-- Edit Patient tab content -->
      <div class="edit-patient-section" *ngIf="activeTab === 'editPatient'">
        <div class="section-header">
          <button class="back-button" (click)="setActiveTab('patients')">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Назад к списку пациентов
          </button>
          <h2>Редактирование пациента</h2>
        </div>
        
        <div class="patient-edit-form" *ngIf="editingPatient">
          <div class="form-group">
            <label for="patientFullName">ФИО</label>
            <input type="text" id="patientFullName" [(ngModel)]="editingPatient.fullName" class="form-control" required 
                   [class.is-invalid]="patientFullNameInvalid && isPatientFormSubmitted">
            <div class="error-feedback" *ngIf="patientFullNameInvalid && isPatientFormSubmitted">
              Введите ФИО пациента
            </div>
          </div>
          
          <div class="form-group">
            <label for="patientRelationship">Пол</label>
            <select id="patientRelationship" [(ngModel)]="editingPatient.relationship" class="form-control" required
                    [class.is-invalid]="patientRelationshipInvalid && isPatientFormSubmitted">
              <option value="">Выберите...</option>
              <option value="male">Мужской</option>
              <option value="female">Женский</option>
            </select>
            <div class="error-feedback" *ngIf="patientRelationshipInvalid && isPatientFormSubmitted">
              Выберите пол пациента
            </div>
          </div>
          
          <div class="form-group">
            <label for="patientBirthDate">Дата рождения</label>
            <input type="date" id="patientBirthDate" [(ngModel)]="editingPatient.birthDate" class="form-control" required
                   [max]="today" 
                   [class.is-invalid]="patientBirthDateInvalid && isPatientFormSubmitted">
            <div class="error-feedback" *ngIf="patientBirthDateInvalid && isPatientFormSubmitted">
              Введите корректную дату рождения (не позднее сегодняшней)
            </div>
          </div>
          
          <div class="form-group">
            <label for="patientAddress">Адрес</label>
            <input type="text" id="patientAddress" [(ngModel)]="editingPatient.address" class="form-control">
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="setActiveTab('patients')">Отмена</button>
            <button type="button" class="btn btn-primary" (click)="savePatient()">Сохранить</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading state -->
<div class="loading" *ngIf="isLoading">
  <div class="spinner-container">
    <div class="spinner"></div>
    <p>Загрузка данных...</p>
  </div>
</div>

<!-- Error state -->
<div class="error-state" *ngIf="!isLoading && !currentUser">
  <p>Не удалось загрузить данные. Пожалуйста, проверьте подключение и обновите страницу.</p>
  <button (click)="loadUserProfile()" class="btn btn-primary">Повторить</button>
</div> 