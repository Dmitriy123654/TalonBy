<div class="schedule-management">
  <!-- Сообщения об ошибках и успехе -->
  <div class="alerts">
    <div *ngIf="errorMessage" class="alert alert-error">
      <i class="icon-error"></i>
      <span>{{ errorMessage }}</span>
      <button (click)="errorMessage = ''" class="close-btn">×</button>
    </div>
    <div *ngIf="saveSuccess" class="alert alert-success">
      <i class="icon-success"></i>
      <span>Настройки успешно сохранены</span>
    </div>
  </div>

  <!-- Выбор больницы (только для администраторов) -->
  <div class="selection-row" *ngIf="userRole === 'Administrator'">
    <div class="hospital-selection">
      <h3>Выберите больницу</h3>
      <div class="search-input">
        <input 
          type="text" 
          [(ngModel)]="hospitalFilter" 
          (input)="filterHospitals()" 
          placeholder="Поиск больницы..."
          class="filter-input"
        >
        <i class="icon-search"></i>
      </div>
      <select [(ngModel)]="selectedHospitalId" (change)="onHospitalChange(selectedHospitalId)">
        <option [ngValue]="0">Выберите больницу</option>
        <option *ngFor="let hospital of hospitals" [ngValue]="hospital.hospitalId">
          {{ hospital.name }}
        </option>
      </select>
    </div>
  </div>

  <!-- Выбор специальности (для администраторов и главврачей) -->
  <div class="selection-row" *ngIf="(userRole === 'Administrator' && selectedHospitalId && specialities.length > 0) || (userRole === 'ChiefDoctor' && specialities.length > 0)">
    <div class="speciality-selection">
      <h3>Выберите специальность</h3>
      <div class="search-input">
        <input 
          type="text" 
          [(ngModel)]="specialityFilter" 
          (input)="filterSpecialities()" 
          placeholder="Поиск специальности..."
          class="filter-input"
        >
        <i class="icon-search"></i>
      </div>
      <select [(ngModel)]="selectedSpecialityId" (change)="onSpecialityChange(selectedSpecialityId)">
        <option [ngValue]="0">Выберите специальность</option>
        <option *ngFor="let speciality of specialities" [ngValue]="speciality.doctorsSpecialityId">
          {{ speciality.name }}
        </option>
      </select>
    </div>
  </div>

  <!-- Выбор врача и периода -->
  <div class="selection-row">
    <!-- Выбор врача (для администраторов и главврачей) -->
    <div class="doctor-selection" *ngIf="(userRole === 'Administrator' && selectedSpecialityId) || (userRole === 'ChiefDoctor' && selectedSpecialityId)">
      <h3>Выберите врача</h3>
      <div class="search-input">
        <input 
          type="text" 
          [(ngModel)]="doctorFilter" 
          (input)="filterDoctors()" 
          placeholder="Поиск врача..."
          class="filter-input"
        >
        <i class="icon-search"></i>
      </div>
      <select [(ngModel)]="selectedDoctorId" (change)="onDoctorChange(selectedDoctorId)">
        <option [ngValue]="0">Выберите врача</option>
        <option *ngFor="let doctor of doctors" [ngValue]="doctor.id">
          {{ doctor.name }} ({{ doctor.specialization }})
        </option>
      </select>
    </div>

    <!-- Выбор периода (для всех) -->
    <div class="period-selection" [ngClass]="{'full-width': userRole === 'Doctor' || userRole === 'ChiefDoctor'}">
      <h3>Выберите период</h3>
      <div class="date-range">
        <div class="date-input">
          <label for="startDate">С:</label>
          <input 
            type="date" 
            id="startDate" 
            [(ngModel)]="startDate" 
            (change)="onPeriodChange()"
            [min]="startDate"
          >
        </div>
        <div class="date-input">
          <label for="endDate">По:</label>
          <input 
            type="date" 
            id="endDate" 
            [(ngModel)]="endDate" 
            (change)="onPeriodChange()"
            [min]="startDate"
            [max]="maxEndDate"
          >
          <div class="date-hint">Не более 3 месяцев от текущей даты</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Настройки расписания -->
  <div class="settings-section">
    <h3>Настройки расписания</h3>
    <form [formGroup]="settingsForm" (ngSubmit)="saveSettings()">
      <div class="settings-grid">
        <div class="form-group">
          <label for="workdayStart">Начало рабочего дня:</label>
          <input 
            type="time" 
            id="workdayStart" 
            formControlName="workdayStart"
          >
          <div *ngIf="settingsForm.controls['workdayStart'].invalid && settingsForm.controls['workdayStart'].touched" class="error">
            Укажите корректное время
          </div>
        </div>

        <div class="form-group">
          <label for="workdayEnd">Конец рабочего дня:</label>
          <input 
            type="time" 
            id="workdayEnd" 
            formControlName="workdayEnd"
          >
          <div *ngIf="settingsForm.controls['workdayEnd'].invalid && settingsForm.controls['workdayEnd'].touched" class="error">
            Укажите корректное время
          </div>
        </div>

        <div class="form-group">
          <label for="slotDuration">Длительность приема (мин):</label>
          <input 
            type="number" 
            id="slotDuration" 
            formControlName="slotDuration"
            min="5" 
            max="60"
          >
          <div *ngIf="settingsForm.controls['slotDuration'].invalid && settingsForm.controls['slotDuration'].touched" class="error">
            Длительность должна быть от 5 до 60 минут
          </div>
        </div>

        <div class="form-group">
          <label for="breakDuration">Перерыв между приемами (мин):</label>
          <select 
            id="breakDuration" 
            formControlName="breakDuration"
          >
            <option *ngFor="let duration of breakOptions" [value]="duration">{{ duration }}</option>
          </select>
          <div *ngIf="settingsForm.controls['breakDuration'].invalid && settingsForm.controls['breakDuration'].touched" class="error">
            Выберите значение из списка
          </div>
        </div>

        <div class="form-group">
          <label for="lunchStart">Начало обеденного перерыва:</label>
          <input 
            type="time" 
            id="lunchStart" 
            formControlName="lunchStart"
          >
          <div *ngIf="settingsForm.controls['lunchStart'].invalid && settingsForm.controls['lunchStart'].touched" class="error">
            Укажите корректное время
          </div>
        </div>

        <div class="form-group">
          <label for="lunchEnd">Конец обеденного перерыва:</label>
          <input 
            type="time" 
            id="lunchEnd" 
            formControlName="lunchEnd"
          >
          <div *ngIf="settingsForm.controls['lunchEnd'].invalid && settingsForm.controls['lunchEnd'].touched" class="error">
            Укажите корректное время
          </div>
        </div>
      </div>

      <div class="workdays-section">
        <label>Рабочие дни:</label>
        <div class="workdays-grid">
          <div *ngFor="let day of weekdays" 
               class="day-checkbox" 
               [class.selected]="isDaySelected(day.id)"
               (click)="toggleDay(day.id)">
            {{ day.name }}
          </div>
        </div>
      </div>

      <div class="auto-generate-section">
        <label class="auto-generate-checkbox">
          <input type="checkbox" [(ngModel)]="autoGenerateEnabled" [ngModelOptions]="{standalone: true}">
          <span class="checkbox-text">Генерировать автоматически</span>
        </label>
      </div>

      <div class="action-buttons">
        <button type="submit" class="btn btn-primary" [disabled]="settingsForm.invalid || isLoading">
          <i class="icon-save"></i> Сохранить настройки
        </button>
        <button type="button" class="btn btn-accent" (click)="generateSchedule()" [disabled]="settingsForm.invalid || isLoading">
          <i class="icon-calendar"></i> Сгенерировать расписание
        </button>
        <button type="button" class="btn btn-danger" (click)="deleteSchedule()" [disabled]="!currentSchedule || isLoading">
          <i class="icon-delete"></i> Удалить расписание
        </button>
        <button type="button" class="btn btn-primary" (click)="updateSchedule()">Изменить расписание</button>
      </div>
    </form>
  </div>

  <!-- Отображение текущего расписания в виде календаря -->
  <div class="schedule-display">
    <div class="schedule-header">
      <h3 *ngIf="currentSchedule">Расписание: {{ currentSchedule.doctorName }} ({{ currentSchedule.specialization }})</h3>
      <h3 *ngIf="!currentSchedule && !isLoading">Календарь</h3>
      <h3 *ngIf="!currentSchedule && isLoading">Загрузка расписания...</h3>
    </div>

    <div class="calendar-wrapper">
      <!-- Показываем календарь, только если данные загружены или это пустой календарь -->
      <div *ngIf="currentSchedule || !isLoading">
        <div class="calendar-header">
          <button class="month-nav" (click)="prevMonth()" [disabled]="!canGoToPrevMonth()">&lt;</button>
          <h3>{{ getMonthName(currentMonth) }} {{ currentMonth.getFullYear() }}</h3>
          <button class="month-nav" (click)="nextMonth()" [disabled]="!canGoToNextMonth()">&gt;</button>
        </div>

        <div class="calendar">
          <div class="weekdays">
            <div class="weekday" *ngFor="let day of calendarWeekDays">{{ day }}</div>
          </div>
          
          <div class="calendar-grid">
            <div class="week" *ngFor="let week of calendarDays">
              <div class="day" *ngFor="let day of week" 
                  [class.weekend]="day.isWeekend"
                  [class.disabled]="day.isDisabled"
                  [class.today]="day.isToday"
                  [class.selected]="selectedCalendarDate && day.date === selectedCalendarDate.getDate() && 
                                  day.month === selectedCalendarDate.getMonth() && 
                                  day.year === selectedCalendarDate.getFullYear()"
                  (click)="selectCalendarDate(day)">
                <div class="day-content">
                  <span class="date">{{ day.date || '' }}</span>
                  <span class="slots" *ngIf="day.date && !day.isDisabled && day.availableSlots > 0">
                    {{ day.availableSlots }}
                  </span>
                </div>
              </div>
            </div>

            <div class="time-slots-row" *ngIf="selectedCalendarDate && selectedDaySlots.length > 0">
              <div class="selected-date">
                {{ formatSelectedDate(selectedCalendarDate) }}, {{ getDayOfWeekForDate(selectedCalendarDate) }}
              </div>
              
              <div class="slot-status-legend">
                <div class="status-item available">Доступно</div>
                <div class="status-item unavailable">Занято</div>
              </div>
              
              <div class="time-slots">
                <div *ngFor="let slot of selectedDaySlots" 
                    class="time-slot" 
                    [class.available]="slot.isAvailable"
                    [class.unavailable]="!slot.isAvailable"
                    (click)="updateSlotAvailability(slot, !slot.isAvailable)">
                  {{ slot.time }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Индикатор загрузки для календаря -->
      <div *ngIf="isLoading" class="calendar-loading">
        <div class="spinner"></div>
        <p>Загрузка и построение расписания...</p>
      </div>
    </div>
  </div>
</div> 